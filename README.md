# README.md
**KoMaTukuru テキスト整形ツール**

**現在のバージョン**: v1.0.3（2025-10-01）

本ツールは、社内の広報・販促物で使う「会期／会場／本文」テキストを、
ブラウザだけで安全・高速に整形するために作られました。ペースト→変換→コピーの
最短 3 ステップで、URL 保護、全角・半角の統一、表記ゆれの解消、会期の開始・終了日時の抽出などを行います。

---

## 1. 経緯（ダイジェスト）
- 既存の手作業整形に時間とバラつきが生じていたため、ルールをコード化。
- 変更容易性のため、**加工パイプライン（`rulesGlobal`）に小さな関数を追加**して拡張する設計に。
- 会期は独自パーサを実装し、**開始／終了日時**を自動抽出。終了日は「火曜は17:30、それ以外19:30」を既定とし、
  文末の「※最終日は午後4時閉場。」等があれば**その時刻を優先**する仕様にしています。

---

## 2. ビルド不要（静的 HTML）
- ファイルは 1 枚の `index.html`（本プロジェクトでは名称自由）だけで動作します。
- 依存関係なし。ローカルでも GitHub Pages でも動作します。

---

## 3. バージョニング方針
- **採用**: [SemVer 2.0.0](https://semver.org/lang/ja/) の記法に準拠（例: `v1.2.3`）。
- **更新ルール**:
  - **PATCH**: 互換性のある不具合修正（例: 既存ルールのバグ修正）。
  - **MINOR**: 後方互換のある機能追加（例: ルール追加・軽微な UI 改善）。
  - **MAJOR**: 互換性のない変更（例: 既存出力形式の破壊的変更）。

> HTML と README の **両方に同じバージョン**を記載してください。

---

## 4. 正規表現ルール（詳細）

**処理順（上から順に適用）**
1. **URL 保護（`urlProtect`）**  
   - 正規表現: `/(https?:\\/\\/[!-~]+)/g`  
   - マッチした URL をプレースホルダに一時退避し、URL 内の**全角英数・記号→半角**、長音等の**横棒類→`-`**に正規化。  
   - 目的: 後続の全角化・置換で URL を壊さない。  
   - 後段で **URL 復元（`urlRestore`）** を実行。

2. **互換単位（`siCompatUnits`）**  
   - 互換文字 → ASCII: `㎝ (U+339D)`→`cm`、`㎖ (U+3396)`→`ml`。  
   - 例: `縦 10㎝` → `縦 10cm`

3. **角括弧・波線の正規化（`fullwidthBracketsAndWave`）**  
   - `[`→`［`、`]`→`］`（角括弧は常に全角）  
   - `~`（U+007E）/ `〜`（U+301C）→ **全角チルダ `～`** に統一

4. **表記ゆれ統一（`lexicalReplacements`）**  
   - 英字（大文字想定のもののみ変換）  
     - `POPUPSTORE`→`POP UP STORE` → `POPUPSHOP`→`POP UP SHOP` → `POPUP`→`POP UP`  
     （※衝突回避のため**長い語から置換**）  
   - 和文  
     - `是非`→`ぜひ`、`くださいませ`→`ください`  
     - `お買い上げ`/`お買いあげ`→`お買上げ`  
     - `致します`→`いたします`、`ラインナップ`→`ラインアップ`  
     - `髙島屋`→`高島屋`

5. **幅・記号の正規化（`widthNorm`）**  
   - **英字・数字は半角**、**記号は原則全角**、空白は半角維持。  
   - 個別置換:  
     - `()`→`（）`、`[]`→`［］`、`{}`→`｛｝`  
     - `< >`→`〈 〉`、`≪ ≫`→`《 》`、`【 】`→`〔 〕`  
     - `*`/`＊`→`※`  
   - **英数連続語中の記号**は読みやすさ優先で**半角に統一**  
     - 例: `ABC／123` → `ABC/123`、`A－B` → `A-B`  
     - ただし **括弧類（［］、（）、《》、〔〕、〈〉、『』、「」）は常に全角**（英数字に挟まれても半角化しない）
   - 長音・ダッシュ類（`‐―－ー‒–—−`）は英数語中では **`-`** に統一

6. **TEL のコロン固定（`fixTelColon`）**  
   - `TEL:` / `TEL：` → 常に **`TEL：`（全角コロン）**

7. **スペース／改行の圧縮（`spaceBreak`）**  
   - スペースの連続 → 半角 1 個  
   - 3 行以上の空行 → **2 行**に圧縮

8. **価格の直前に全角スペース付与（`ensureZenkakuSpaceBeforePrice`）**  
   **現在は無効化（v1.0.2, 2025-09-24）** — 再有効化する場合は `PRICE_SPACE_RULE_ENABLED = true`。
   - 価格判定: `\\d{1,3}(?:,\\d{3})+|\\d+` **直後が「円」**  
     - 対応例: `000円`、`0,000円`、`00,000円`、`000,000円`、`0,000,000円`  
     - **「円」が無ければ数値列として扱い、対象外**  
   - 付与ロジック: 行頭以外の出現に **直前へ全角スペース `　` を 1 つ**  
     - 例: `特価1,980円` → `特価　1,980円`  
   - 例外: **`税込…円以上`** は**付与しない**  
     - 例: `税込1,000円以上` → 変更なし

9. **URL 復元（`urlRestore`）**  
   - 手順 1 で保護した URL を元に戻す（内部は半角化済み）

### 会期パーサ（詳細）

**入力の正規化**
- 全角数字 → 半角数字（解析用）  
- `〜 / ~ / - / ‐ / ― / ー / – / — / − / →` を **すべて `～` に統一**（※`→` も**範囲セパレータ**として扱う）  
- 丸括弧は全角へ：`(` / `)` → `（` / `）`  
- 空白は除去して解析

**対応パターン**
1. **範囲**: `X月Y日（…）～M月N日（…）` / `X/Y～M/N` / `X月Y日～N日` ほか  
   - 右側に年が無い場合、**開始より月が小さければ +1 年**  
   - 曜日は `Date` から自動付与。`祝`/`振` は丸括弧の語から推定（`…祝…`/`…振…`）
2. **列挙**: `■9/10（…）・11日（…）・12日（…）`  
   - 括弧外の `・` で分割。月省略時は**直前の月を継承**。年は**月が戻ったら +1 年**  
   - 出力は `■9月10日（…）・11日（…）・…`
3. **単日**: `■9/10（…）` / `■9月10日（…）`
4. **「開催中～」**: 左側が**ちょうど**`開催中` のとき、右側の日付のみ解析  
   - 出力例: `■開催中～9月16日（火）`

**開始・終了日時の決定**
- 既定：開始 10:30、終了 19:30（店舗ラジオボタンで「新宿」が選択されている場合：火曜のみ **17:30**）
- 店舗ラジオボタンで「日本橋」が選択されている場合：火曜の終了時刻は **19:30** に固定（通常の火曜 17:30 ルールを上書き）
- 行末の注意書き（`※...`）から **`(午前|午後)h時( m分)`** を抽出できた場合、終了時刻を上書き
  - 例: `※最終日は午後4時閉場。` → 終了 16:00
  - 数字は全角でも解釈（例: `午後４時`）
- 注意書き本文は出力にも残す（全体ルールで整形したものを付与）

**その他の生成ルール**
- 先頭に **`■` を付与**（一部ケースは既存 `■` を維持）  
- 入力に `開催中` が含まれていたら、出力にも**必ず反映**  
  - `開催中～` / `開催中→` が入力にあれば、出力は**`開催中～`**で統一

### 会場の整形（個別ルール）
- 行ごとに先頭へ **`■` を強制付与**（空行はそのまま）  
- そのほかは**全体ルール（transform）**を適用

### 本文の整形（個別ルール）
- 会期／会場の出力を `<p>...</p>` として先頭に挿入し、空行として `<p><br></p>` を 1 行挿入  
- 本文は**各行末に `<br>` を付与**。空行は `<br>` のみ

---

## 5. 変更履歴（Changelog）
- **2025-10-01**: v1.0.3 本文を **全文 `<p>...</p>` で囲む**出力に変更（会期・会場→`<p><br></p>`→本文 `<p>`）**括弧類は常に全角**に統一（英数字に挟まれても半角化しないよう `widthNorm` を調整）。店舗ラジオボタンを追加。「日本橋」を選択時は火曜でも終了時刻を 19:30 とする仕様を追加。
- **2025-09-24**: v1.0.2 「価格直前の全角スペース付与」を内部フラグで**無効化**（将来 `PRICE_SPACE_RULE_ENABLED = true` で復活可能）。
- **2025-09-16**: v1.0.1 右上のバージョン表記をボタン化。クリックで**会期タイトルの右横（`.dt-free`）以外**の欄をクリア。
- **2025-09-05**: v1.0.0 初回社内公開
- **2025-09-05**: 角括弧・波線の全角固定ルールを追加
- **2025-09-05**: 価格直前の全角スペース挿入（`税込…円以上` は除外）を追加
- **2025-09-05**: 会期で `→` を `～` と同義として扱う仕様を追加
- **2025-09-05**: 会期で「※最終日は午後4時閉場。」等の注意書きで終了時刻を上書きする仕様を追加

---

## 6. バージョンの埋め込み（HTML への表示）

HTML 冒頭とヘッダーに **同一のバージョン番号**を表示します。既存ファイルに以下を追記してください。

### 6.1 `<head>` に追記
```html
<!-- Text Formatter v1.0.0 - 2025-09-05 -->
<meta name="app-version" content="v1.0.0">
