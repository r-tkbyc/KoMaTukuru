# README.md
**KoMaTukuru テキスト整形ツール**

**現在のバージョン**: v1.0.6（2026-01-05）

本ツールは、社内の広報・販促物で使う「会期／会場／本文」テキストを、
ブラウザだけで安全・高速に整形するために作られました。ペースト→変換→コピーの
最短 3 ステップで、URL 保護、全角・半角の統一、表記ゆれの解消、会期の開始・終了日時の抽出などを行います。

---

## 1. 経緯（ダイジェスト）
- 既存の手作業整形に時間とバラつきが生じていたため、ルールをコード化。
- 変更容易性のため、**加工パイプライン（`rulesGlobal`）に小さな関数を追加**して拡張する設計に。
- 会期は独自パーサを実装し、**開始／終了日時**を自動抽出。終了日は「火曜は17:30、それ以外19:30」を既定とし、
  文末の「※最終日は午後4時閉場。」等があれば**その時刻を優先**する仕様にしています。

---

## 2. ビルド不要（静的 HTML）
- ファイルは 1 枚の `index.html`（本プロジェクトでは名称自由）だけで動作します。
- 依存関係なし。ローカルでも GitHub Pages でも動作します。

---

## 3. バージョニング方針
- **採用**: [SemVer 2.0.0](https://semver.org/lang/ja/) の記法に準拠（例: `v1.2.3`）。
- **更新ルール**:
  - **PATCH**: 互換性のある不具合修正（例: 既存ルールのバグ修正）。
  - **MINOR**: 後方互換のある機能追加（例: ルール追加・軽微な UI 改善）。
  - **MAJOR**: 互換性のない変更（例: 既存出力形式の破壊的変更）。

> HTML と README の **両方に同じバージョン**を記載してください。

---

## 4. 正規表現ルール（詳細）

**処理順（上から順に適用）**
1. **URL 保護（`urlProtect`）**  
   - 正規表現: `/(https?:\\/\\/[!-~]+)/g`  
   - マッチした URL をプレースホルダに一時退避し、URL 内の**全角英数・記号→半角**、長音等の**横棒類→`-`**に正規化。  
   - 目的: 後続の全角化・置換で URL を壊さない。  
   - 後段で **URL 復元（`urlRestore`）** を実行。

2. **互換単位（`siCompatUnits`）**  
   - 互換文字 → ASCII: `㎝ (U+339D)`→`cm`、`㎖ (U+3396)`→`ml`、`㎜ (U+339C)`→`mm`。  
   - 例: `縦 10㎝` → `縦 10cm`
   - 互換文字 → ASCII: `㎝ (U+339D)`→`cm`、`㎖ (U+3396)`→`ml`、`㎜ (U+339C)`→`mm`

3. **角括弧・波線の正規化（`fullwidthBracketsAndWave`）**  
   - `[`→`［`、`]`→`］`（角括弧は常に全角）  
   - `~`（U+007E）/ `〜`（U+301C）→ **全角チルダ `～`** に統一

4. **表記ゆれ統一（`lexicalReplacements`）**  
   - 英字（大文字想定のもののみ変換）  
     - `POPUPSTORE`→`POP UP STORE` → `POPUPSHOP`→`POP UP SHOP` → `POPUP`→`POP UP`  
     （※衝突回避のため**長い語から置換**）  
   - 和文  
     - `是非`→`ぜひ`、`くださいませ`→`ください`  
     - `お買い上げ`/`お買いあげ`→`お買上げ`  
     - `致します`→`いたします`、`ラインナップ`→`ラインアップ`  
     - `髙島屋`→`高島屋`

5. **幅・記号の正規化（`widthNorm`）**  
   - **英字・数字は半角**、**記号は原則全角**、空白は半角維持。  
   - 個別置換:  
     - `()`→`（）`、`[]`→`［］`、`{}`→`｛｝`  
     - `< >`→`〈 〉`、`≪ ≫`→`《 》`、`【 】`→`〔 〕`  
     - `*`/`＊`→`※`  
   - **英数連続語中の記号**は読みやすさ優先で**半角に統一**  
     - 例: `ABC／123` → `ABC/123`、`A－B` → `A-B`  
     - ただし **括弧類（［］、（）、《》、〔〕、〈〉、『』、「」）は常に全角**（英数字に挟まれても半角化しない）
   - 長音・ダッシュ類（`‐―－ー‒–—−`）は英数語中では **`-`** に統一

6. **TEL のコロン固定（`fixTelColon`）**  
   - `TEL:` / `TEL：` → 常に **`TEL：`（全角コロン）**

7. **スペース／改行の圧縮（`spaceBreak`）**  
   - スペースの連続 → 半角 1 個  
   - 3 行以上の空行 → **2 行**に圧縮

8. **価格の直前に全角スペース付与（`ensureZenkakuSpaceBeforePrice`）**  
   **現在は無効化（v1.0.2, 2025-09-24）** — 再有効化する場合は `PRICE_SPACE_RULE_ENABLED = true`。
   - 価格判定: `\\d{1,3}(?:,\\d{3})+|\\d+` **直後が「円」**  
     - 対応例: `000円`、`0,000円`、`00,000円`、`000,000円`、`0,000,000円`  
     - **「円」が無ければ数値列として扱い、対象外**  
   - 付与ロジック: 行頭以外の出現に **直前へ全角スペース `　` を 1 つ**  
     - 例: `特価1,980円` → `特価　1,980円`  
   - 例外: **`税込…円以上`** は**付与しない**  
     - 例: `税込1,000円以上` → 変更なし

9. **URL 復元（`urlRestore`）**  
   - 手順 1 で保護した URL を元に戻す（内部は半角化済み）

### 会期パーサ（詳細）

**入力の正規化**
- 全角数字 → 半角数字（解析用）  
- `〜 / ~ / - / ‐ / ― / ー / – / — / − / →` を **すべて `～` に統一**（※`→` も**範囲セパレータ**として扱う）  
- 丸括弧は全角へ：`(` / `)` → `（` / `）`  
- 空白は除去して解析

**対応パターン**
1. **範囲**: `X月Y日（…）～M月N日（…）` / `X/Y～M/N` / `X月Y日～N日` ほか  
   - 右側に年が無い場合、**開始より月が小さければ +1 年**  
   - 曜日は `Date` から自動付与。`祝`/`振` は丸括弧の語から推定（`…祝…`/`…振…`）
2. **列挙**: `■9/10（…）・11日（…）・12日（…）`  
   - 括弧外の `・` で分割。月省略時は**直前の月を継承**。年は**月が戻ったら +1 年**  
   - 出力は `■9月10日（…）・11日（…）・…`
3. **単日**: `■9/10（…）` / `■9月10日（…）`
4. **「開催中～」**: 左側が**ちょうど**`開催中` のとき、右側の日付のみ解析  
   - 出力例: `■開催中～9月16日（火）`

**開始・終了日時の決定**
- 既定：開始 10:30、終了 19:30（店舗ラジオボタンで「新宿」が選択されている場合：火曜のみ **17:30**）
- 店舗ラジオボタンで「日本橋」が選択されている場合：火曜の終了時刻は **19:30** に固定（通常の火曜 17:30 ルールを上書き）
- 行末の注意書き（`※...`）から **`(午前|午後)h時( m分)`** を抽出できた場合、終了時刻を上書き
  - 例: `※最終日は午後4時閉場。` → 終了 16:00
  - 数字は全角でも解釈（例: `午後４時`）
- 注意書き本文は出力にも残す（全体ルールで整形したものを付与）
- 会場入力欄の行末に **「※最終日は午後X時（Y分）閉場。」** のような注意書きがある場合、
  そこから抽出した時刻（`(午前|午後)h時( m分)` を全角半角不問で解析）を **終了時刻として上書き**します。
  この上書きは会期の出力に反映されます（会場→会期の順で変換するか、会場変換後に会期を再変換してください）。

**終了時刻の優先順位（高 → 低）**
1. **会場の注意書き（※）**で抽出した時刻（グローバルに適用）
2. **会期各行の注意書き（※）**で抽出した時刻（行単位で適用）
3. **店舗既定ルール**  
   - 新宿: 火曜は **17:30**、それ以外 **19:30**  
   - 日本橋: **常に 19:30**（火曜でも 19:30）

**その他の生成ルール**
- 先頭に **`■` を付与**（一部ケースは既存 `■` を維持）  
- 入力に `開催中` が含まれていたら、出力にも**必ず反映**  
  - `開催中～` / `開催中→` が入力にあれば、出力は**`開催中～`**で統一

### 会場の整形（個別ルール）
- 行ごとに先頭へ **`■` を強制付与**（空行はそのまま）  
- そのほかは**全体ルール（transform）**を適用
- 行末の「※…閉場。」から **終了時刻を抽出**し、**会期の終了時刻上書きに利用**します（抽出は `(午前|午後)h時( m分)` 形式、全角半角混在OK）。
- この上書きは **会場を変換した後に会期を変換**した場合に反映されます。すでに会期を変換済みなら、**会場変換ののち会期を再変換**してください。
- 店舗ラジオ（新宿／日本橋）の既定ロジックは**これまで通り**有効で、上記※での上書きがある場合はその値が優先されます。


### 本文の整形（個別ルール）
- 会期／会場の出力を `<p>...</p>` として先頭に挿入し、空行として `<p><br></p>` を 1 行挿入  
- 本文は**各行末に `<br>` を付与**。空行は `<br>` のみ

---

## 5. 変更履歴（Changelog）
- **2026-01-05**: v1.0.6
  - 基準年を 2026 に変更。右上バージョン（クリア）押下時に「年セレクト」と「店舗ラジオ」「任意日時」を保持する仕様に統一。
  - 正規表現ルールを拡張（互換単位に ㎜→mm を追加、波線統一で ~→～ を明記）。HTML 内のバージョン表記を v1.0.6 / 2026-01-05 に更新。
- **2025-12-08**: v1.0.5
  - 正規表現の追加`㎜ → mm`。
  - 基準となる年を2025から2026に変更。
- **2025-11-04**: v1.0.4  
  - **会場入力欄の「※最終日は午後X時（Y分）閉場。」**を解析し、会期の終了時刻を**自動上書き**できるようにしました。  
  - 終了時刻の**優先順位**を明文化（会場※ ＞ 会期行※ ＞ 店舗既定ルール）。  
  - 運用上の注意を追記：会場で※がある場合は、**会場→会期の順**で変換するか、会場変換後に**会期を再変換**してください。  
  - 既存の店舗ラジオ（新宿／日本橋）ロジックと互換（挙動は従来どおり）。
- **2025-10-01**: v1.0.3 本文を **全文 `<p>...</p>` で囲む**出力に変更（会期・会場→`<p><br></p>`→本文 `<p>`）**括弧類は常に全角**に統一（英数字に挟まれても半角化しないよう `widthNorm` を調整）。店舗ラジオボタンを追加。「日本橋」を選択時は火曜でも終了時刻を 19:30 とする仕様を追加。
- **2025-09-24**: v1.0.2 「価格直前の全角スペース付与」を内部フラグで**無効化**（将来 `PRICE_SPACE_RULE_ENABLED = true` で復活可能）。
- **2025-09-16**: v1.0.1 右上のバージョン表記をボタン化。クリックで**会期タイトルの右横（`.dt-free`）以外**の欄をクリア。
- **2025-09-05**: v1.0.0 初回社内公開
- **2025-09-05**: 角括弧・波線の全角固定ルールを追加
- **2025-09-05**: 価格直前の全角スペース挿入（`税込…円以上` は除外）を追加
- **2025-09-05**: 会期で `→` を `～` と同義として扱う仕様を追加
- **2025-09-05**: 会期で「※最終日は午後4時閉場。」等の注意書きで終了時刻を上書きする仕様を追加

---

## 6. バージョンの埋め込み（HTML への表示）

HTML 冒頭とヘッダーに **同一のバージョン番号**を表示します。既存ファイルに以下を追記してください。

### 6.1 `<head>` に追記
```html```
<!-- Text Formatter v1.0.6 - 2026-01-05 -->
<meta name="app-version" content="v1.0.6">

---

## 7. KoMaTukuru → CMS 自動入力（Chrome拡張による流し込み）

### 7.1 目的
KoMaTukuruで整形した結果を、別タブで開いている CMS（記事新規作成画面）の複数フォームへ **ワンクリックで自動入力**するための仕組みです。  
運用は Chrome のウインドウ（またはタブ）を2つ開き、KoMaTukuru と CMS を同時に表示して行います。

### 7.2 技術的な方式（全体像）
Chrome拡張（Manifest V3）で、**3つの役割**に分けて実装します。

- **koma_inject（KoMaTukuru側のコンテンツスクリプト）**
  - KoMaTukuruのUIへ `toCMS` ボタンを追加（タイトルセットの変換ボタン左）
  - ボタン押下で、KoMaTukuruの各出力欄から値を収集して「送信データ」を生成
  - `chrome.runtime.sendMessage()` で background に送信

- **background（中継・タブ特定）**
  - 「最後に触ったCMSタブ」を記憶（ユーザーが操作したCMSタブを優先）
  - KoMaTukuruから受け取った送信データを、そのCMSタブへ `chrome.tabs.sendMessage()` で中継

- **cms_inject（CMS側のコンテンツスクリプト）**
  - CMSのフォーム要素を `id`（または安全なセレクタ）で取得し、値を反映
  - **空欄のときだけ入力**して事故を防止
  - 入力後に `input` / `change` 等のイベントを発火して、CMS側のバリデーションやUI更新を確実に動かす
  - 反映完了後、簡易ダイアログを表示（例：「タイトルが入力完了」＋OK）

> iframe ではない想定で、通常の DOM への入力として扱います（記事本文編集の Broccoli iframe は今回の対象外）。

### 7.3 対象URL（誤爆防止）
拡張が入力を行うのは、次の **共通プレフィックス** に一致する「記事新規作成画面」のみです。  
`&category=` 以降が変わっても対象になります。

- **新宿（store_id=2 / suffix=1）**  
  `https://cmstakashimaya.com/webadmin/addon/store/article/create/?store_id=2&store_suffix_number=1`

- **日本橋（store_id=1 / suffix=2）**  
  `https://cmstakashimaya.com/webadmin/addon/store/article/create/?store_id=1&store_suffix_number=2`

---

### 7.4 KoMaTukuru → CMS の入力マッピング（基本）
KoMaTukuruのどの値を、CMSのどの入力欄へ入れるかの対応表です。

- **タイトル（KoMaTukuru：タイトルセット出力）**
  - → CMS `管理名`（`#manage_name_name`）
  - → CMS `タイトル`（`#title`）

- **公開開始日時（KoMaTukuru：会期の dt-free）**
  - → CMS `公開開始日時`（`#public_from_date`）  
  - 形式は **`YYYY/MM/DD HH:mm`**（例：`2026/01/19 12:30`）をそのまま使用

- **会期（KoMaTukuru：会期セット出力 kaiki-output）**
  - → CMS `会期`（`#period`）

- **開催開始日時（KoMaTukuru：会期 date-start）**
  - → CMS `開催開始日時`（`#article_from_date`）

- **開催終了日時（KoMaTukuru：会期 date-end）**
  - → CMS `開催終了日時`（`#article_to_date`）
  - → CMS `公開終了日時`（`#public_to_date`）

---

### 7.5 フロア（会場 → 階抽出 → select 選択）
KoMaTukuruには「フロア」専用項目がないため、**会場出力から抽出**して CMS のフロア select を選択します。

#### 7.5.1 階の抽出ルール（会場テキスト）
会場出力（`[data-set="venue"] textarea.output`）の各行から、次を抽出します。

- `地下N階`（例：`地下1階`）
- `N階`（例：`6階`）
- `屋上`（日本橋のみ出現しうる）

例：
- `■地下1階［Takase］` → `地下1階`
- `■オム・メゾン6階 紳士鞄` → `6階`

#### 7.5.2 新宿のマッピング
運用上 **南館は使わない**ため、必ず **「館なし」** を選びます。

- `地下1階` → `新宿 館なし 地下1階`
- `1階` → `新宿 館なし 1階`
- …
- `14階` → `新宿 館なし 14階`

#### 7.5.3 日本橋のマッピング
日本橋は会場行に **館名（本館/新館/東館）** が必ず入る運用ルール。  
したがって **「館名 + 階」** をキーにして select を選択します。

入力例：
- `■本館1階 婦人服` → `日本橋 本館 1階`
- `■本館地下1階 惣菜［ブランド］` → `日本橋 本館 地下1階`
- `■新館5階 …` → `日本橋 新館 5階`
- `■東館屋上 …` → `日本橋 東館 屋上`

> 日本橋は同じ階が複数館に存在するため、「階だけ一致」では誤選択になります。必ず館名込みで一致させます。

---

### 7.6 入力の確定（イベント発火とUI依存への対応）
CMS側は datetimepicker や validationEngine を使っているため、単に `value` を入れるだけでなく、次を行う前提です。

- `el.value = "..."` の後に
  - `el.dispatchEvent(new Event("input", {bubbles:true}))`
  - `el.dispatchEvent(new Event("change", {bubbles:true}))`
  を発火して確定させる

これにより、
- バリデーション（required / past / future など）
- カレンダーUIの内部状態
- 保存ボタン有効化など
が正しく追従しやすくなります。

---

### 7.7 事故防止（ここ重要）
運用方針として、次の安全策を必須にします。

- **空欄の入力欄にだけ反映**
  - 既に値が入っている欄は上書きしない
- **対象URLに一致しないページでは何もしない**
- **送り先は「最後に触ったCMSタブ」**
  - 2画面運用時、現在ユーザーが触っているCMSを優先して誤爆を避ける

---

### 7.8 操作フロー（運用手順）
1. Chromeで **KoMaTukuru** を開く（GitHub Pages）
2. 別ウインドウ（または別タブ）で **CMSの新規作成画面** を開く
3. 先に CMS 側の対象ページを一度クリックして「最後に触ったCMS」にする
4. KoMaTukuruで整形（必要なら会期→会場の順など、通常運用どおり）
5. KoMaTukuruの `toCMS` を押す
6. CMS側の対象欄が自動入力され、最後に簡易ダイアログが出る（OKで閉じる）

---

### 7.9 KoMaTukuru側の参照DOM（前提）
拡張は KoMaTukuru側で主に次の要素を参照します。  
`index.html` の構造を大きく変える場合、拡張側セレクタも更新が必要です。

- タイトル出力：`[data-set="title"] textarea.output`
- dt-free：`[data-set="kaiki"] .dt-free`
- 会期出力：`[data-set="kaiki"] textarea.output.kaiki-output`
- 開始日：`[data-set="kaiki"] textarea.date-start`
- 終了日：`[data-set="kaiki"] textarea.date-end`
- 会場出力：`[data-set="venue"] textarea.output`

---

### 7.10 CMS側の参照DOM（新宿CMSの例）
今回提示された HTML 断片から、対象になっている主な入力欄は次です。

- 管理名：`#manage_name_name`
- 公開開始日時：`#public_from_date`
- 公開終了日時：`#public_to_date`
- タイトル：`#title`
- 会期：`#period`
- 開催開始日時：`#article_from_date`
- 開催終了日時：`#article_to_date`
- フロア：`#article_floor`（`multiple`）

> `multiple` のため、将来「会場に複数行ある → フロア複数選択」に拡張可能です（現状は運用ルールに合わせて必要最小の選択でもOK）。

---
